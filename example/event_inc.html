<!DOCTYPE html>
<html>
    <head>
    <script type="text/javascript" src="../dist/lemo-client.js"></script>
    <script type="text/javascript">

        var LemoClient = require('lemo-client');
        var lemoClient = new LemoClient();
        lemoClient.setProvider(new LemoClient.providers.HttpProvider('http://localhost:8545'));

        // source is in event_inc.sol
        var compiled = {
            "abi": [{"constant":true,"inputs":[],"name":"x","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"inc","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"odd","type":"bool"},{"indexed":false,"name":"x","type":"uint256"}],"name":"Incremented","type":"event"}],
            "bin": "608060405234801561001057600080fd5b506046600055610100806100256000396000f30060806040526004361060485763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416630c55699c8114604d578063371303c0146071575b600080fd5b348015605857600080fd5b50605f6085565b60408051918252519081900360200190f35b348015607c57600080fd5b506083608b565b005b60005481565b60008054600190810191829055604080518381529051928216909114917f6e61ef44ac2747ff8b84d353a908eb8bd5c3fb118334d57698c5cfc7041196ad9181900360200190a25600a165627a7a72305820a375ae7e9d1121acad50cc44d6df78fbc0d13af027e3413b1c4629d4121184510029",
            "metadata": {"compiler":{"version":"0.4.24+commit.6ae8fb59"},"language":"Solidity","output":{"abi":[{"constant":true,"inputs":[],"name":"x","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"inc","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"odd","type":"bool"},{"indexed":false,"name":"x","type":"uint256"}],"name":"Incremented","type":"event"}],"devdoc":{"methods":{}},"userdoc":{"methods":{}}},"settings":{"compilationTarget":{"event_inc.sol":"Contract"},"evmVersion":"byzantium","libraries":{},"optimizer":{"enabled":true,"runs":200},"remappings":[]},"sources":{"event_inc.sol":{"keccak256":"0xd9c4b466af6fe871d5f63c59dc1a3a3de7cbbee4b655cd72ddd9f979ad978785","urls":["bzzr://9297e8f2b4dcaadbfc077afa204d2bc19b1d0edf7c19161fbfde5a7edfa35c97"]}},"version":1}
        };
        var code = '0x' + compiled.bin;
        // contract json abi, this is autogenerated using solc CLI
        var abi = compiled.abi;

        var address;
        var contract;
        var inc;

        var update = function (err, x) {
            document.getElementById('result').textContent = JSON.stringify(x, null, 2);
        };

        var createContract = function () {
            // let's assume that we have a private key to coinbase ;)
            lemoClient.lemo.defaultAccount = lemoClient.lemo.coinbase;

            document.getElementById('create').style.visibility = 'hidden';
            document.getElementById('status').innerText = "transaction sent, waiting for confirmation";

            lemoClient.lemo.contract(abi).new({data: code, gas: 150000}, function (err, c) {
                if (err) {
                    console.error(err);
                    return;

                // callback fires twice, we only want the second call when the contract is deployed
                } else if(c.address){

                    contract = c;
                    console.log('address: ' + contract.address);
                    document.getElementById('status').innerText = 'Mined!';
                    document.getElementById('call').style.visibility = 'visible';

                    inc = contract.Incremented({odd: true}, update);
                }
            });
        };

        var counter = 0;
        var callContract = function () {
            counter++;
            var all = 70 + counter;
            document.getElementById('count').innerText = 'Transaction sent ' + counter + ' times. ' +
                'Expected x value is: ' + (all - (all % 2 ? 0 : 1)) + ' ' +
                'Waiting for the blocks to be mined...';

            contract.inc();
        };


    </script>
    </head>

    <body>
        <div id="status"></div>
        <div>
            <button id="create" type="button" onClick="createContract();">create contract</button>
        </div>
        <div>
            <button id="call" style="visibility: hidden;" type="button" onClick="callContract();">test1</button>
        </div>
        <div id='count'></div>
        <div id="result">
        </div>
    </body>
</html>
